{% extends 'front-base.html.twig' %}

{% block title %}Небесный Архив - Вечная память близких{% endblock %}
{% block body_id 'homepage' %}

{% block body %}
<div class="na-hero">
  <div class="na-hero__topbar container">
    <div class="na-topline">
      <button
        class="na-nav-toggle"
        type="button"
        aria-label="Переключить меню"
        aria-controls="naTopPanel"
        aria-expanded="false"
        data-nav-toggle
      >
        <span></span>
        <span></span>
        <span></span>
      </button>

      <div class="na-logo fw-semibold">
        <img src="{{ asset('images/logo.webp') }}" alt="Небесный Архив" class="na-logo__img" loading="eager" fetchpriority="high" decoding="sync">
      </div>

      <div class="na-topline__panel" id="naTopPanel" data-nav-panel aria-hidden="false">
        <div class="na-lang-switch" role="navigation" aria-label="Переключение языка">
          <a class="na-lang-switch__item active" href="#" data-lang="ru">RU</a>
          <a class="na-lang-switch__item" href="#" data-lang="en">EN</a>
        </div>

        <div class="na-top-links">
          <button class="na-chip small" type="button" data-modal-open="register">РЕГИСТРАЦИЯ</button>
          <button class="na-chip small" type="button" data-modal-open="login">ВОЙТИ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="na-hero__inner container">
    <div class="row g-0 align-items-start">
      {# ---------- LEFT COLUMN ---------- #}
      <div class="col-lg-6">
        <div class="na-left">

          {# top main marketing block #}
          <div class="na-left-main">
            <h1 class="na-left-main__title">
              ПОВЫСЬТЕ<br/>
              ПРОДАЖИ
            </h1>
            <p class="na-left-main__subtitle">
              по изготовлению памятников,<br/>
              предлагая дополнительную услугу<br/>
              виртуальной страницы памяти<br/>
              на памятнике.
            </p>

            <div class="na-left-pill">
              <span class="na-left-pill__number">5</span>
              <span class="na-left-pill__text">
                попробуйте и получите<br/>
                пять бесплатных QR-кодов
              </span>
            </div>
          </div>

          {# secondary "Небесный архив" card #}
          <div class="na-copy mt-4">
            <h2 class="na-copy__title">НЕБЕСНЫЙ<br/>АРХИВ</h2>
            <p class="na-copy__text">
              Онлайн-сервис сохранения памяти о близких.
              Наш сервис позволяет сохранять биографию,
              фото, видео, координаты захоронения.
            </p>
            <p class="na-copy__text mb-0">
              Создание страницы памяти происходит автоматически
              при заполнении формы при первом переходе по QR-коду.
              В дальнейшем QR-код служит ссылкой на страницу
              памяти об ушедшем.
            </p>
          </div>

          {# small quality badge text (optional) #}
          <div class="na-quality mt-3">
            100% гарантия&nbsp;качества и надёжности сервиса
          </div>
        </div>
      </div>

      {# ---------- RIGHT COLUMN / ANGEL ---------- #}
      <div class="col-lg-6 position-relative">
        <div class="na-angel">

          {# back fog behind angel #}
          <img
            src="{{ asset('images/fog-three.webp') }}"
            alt=""
            class="na-angel__fog-back"
            aria-hidden="true"
            loading="lazy"
            decoding="async"
          >

          {# circle pattern behind angel #}
          <img
            src="{{ asset('images/circle.webp') }}"
            alt=""
            class="na-angel__circle"
            aria-hidden="true"
            loading="lazy"
            decoding="async"
          >

          {# main statue #}
          <img
            src="{{ asset('images/angel.webp') }}"
            alt="Ангел хранитель"
            class="na-angel__img"
            loading="eager"
            fetchpriority="high"
            decoding="sync"
          >

          {# front fog over the base of the statue #}
          <img
            src="{{ asset('images/front-fog.webp') }}"
            alt=""
            class="na-angel__fog-front"
            aria-hidden="true"
            loading="lazy"
            decoding="async"
          >

          {# play button near shoulder #}
          <button class="na-play" type="button" aria-label="Как это работает">
            <img
              src="{{ asset('images/play-button.webp') }}"
              alt=""
              class="na-play__img"
              loading="eager"
              decoding="async"
            >
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<section class="na-section-how">
  <style>
    @font-face {
      font-family: "FranklinGothicCond";
      src: url("{{ asset('fonts/ofont.ru_Franklin Gothic Medium Cond.ttf') }}") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }


    /* second section pulled up a bit to hide any 1px gap */
    .na-section-how {
      position: relative;
      margin-top: -3px;
    }

    /* небольшой градиент-перекрытие стыка сверху второй секции */
    .na-section-how::before {
      content: "";
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(
        to bottom,
        rgba(17,18,20,0) 0%,
        #111214 100%
      );
      pointer-events: none;
      z-index: 0;
    }

    .how-page {
      position: relative;
      z-index: 1;
      width: 100%;
      min-height: 780px;
      background:
        /* Two-point radial gradient at top */
        radial-gradient(ellipse 700px 500px at 25% 20%, rgba(81,106,139,0.5) 0%, rgba(49,70,100,0.3) 40%, transparent 70%),
        radial-gradient(ellipse 600px 400px at 70% 30%, rgba(81,106,139,0.4) 0%, rgba(49,70,100,0.25) 40%, transparent 70%),
        /* Transition gradient from bluish to dark */
        linear-gradient(to bottom, 
          #111214 0%,    /* совпадает с предыдущей секцией */
          #111214 25%,   /* держим одинаковый цвет выше стыка */
          #0a0d12 50%, 
          #0d0f12 75%, 
          #111214 100%);
      overflow-x: visible; /* Allow hand to extend beyond right border */
      overflow-y: visible; /* Allow fog to display at bottom */
      color: #fff;
      padding: 100px 0 200px;
    }

    .how-inner {
      position: relative;
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 40px;
      text-align: center;
      z-index: 3; /* контент выше тумана, ниже руки */
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow: visible; /* Allow hand to extend beyond borders */
    }

    .how-title-text {
      margin: 0 auto 60px;
      max-width: 900px;
      font-family: "FranklinGothicCond", "Times New Roman", serif;
      font-size: 42px;
      line-height: 1.15;
      text-transform: uppercase;
      letter-spacing: .09em;
    }
    .how-title-text span {
      display: block;
    }

    /* Туман — на разделителе между секциями 2 и 3 */
    .how-fog-back,
    .how-fog-front {
      position: absolute;
      left: 0;
      transform: none;
      width: 110%;
      max-width: none;
      pointer-events: none;
      z-index: 1; /* за контентом, но выше фона */
      object-fit: cover;
      object-position: left bottom;
    }
    .how-fog-back {
      bottom: -60px;
      opacity: 0.6;
    }
    .how-fog-front {
      bottom: -40px;
      opacity: 0.9;
    }

    .how-page::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 220px;
      background: linear-gradient(to bottom, rgba(3,6,18,0) 0%, rgba(17,18,20,0.4) 60%, #111214 100%);
      z-index: 1;
      pointer-events: none;
    }


    .how-fog-back {
  z-index: 10 !important;   /* above everything */
  pointer-events: none !important; /* fog doesn’t block clicks */
}


    .how-center {
      position: absolute;
      top: 175px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 0; /* Below fog so it peeks from behind */
    }
    .how-tombstone {
      max-height: 800px;
    }

    .how-steps {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 42px;
      margin-top: 210px;
      z-index: 6;
      overflow: visible; /* Allow hand to extend beyond */
    }

    .how-step {
      position: relative;
      flex: 0 0 auto;
    }

    .how-step-phone {
      display: inline-block;
      max-height: 260px;
    }

    .how-step--3 .how-step-phone {
      max-height: 320px;
    }

    .how-step-badge {
      display: block;
      margin: 18px auto 10px;
      max-width: 54px;
    }

    .how-step-caption {
      max-width: 220px;
      margin: 0 auto;
      font-size: 14px;
      line-height: 1.4;
      color: rgba(255,255,255,.92);
      font-family: "FranklinGothicCond", system-ui, sans-serif;
      font-weight: 700; /* bold */
    }

    .how-step--2 .how-step-flash {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 160px;
      z-index: -1;
    }

    .how-step--5 {
      margin-left: 10px;
      text-align: left;
      max-width: 260px;
      z-index: 6; /* above the hand image */
      position: relative;
    }
   .how-step--5 .how-step-badge {
  margin-top: 28px;           /* как тебе нужно по умолчанию */
  }
  .how-step--5 .how-step-caption {
    margin-top: 15px;
  }

    .how-bottom-text {
      margin-top: 60px;
      font-family: "FranklinGothicCond", "Times New Roman", serif;
      font-size: 26px;
      line-height: 1.3;
      letter-spacing: .03em;
      z-index: 3;
      position: relative;
    }

    /* Рука — поверх всего (и над «5»), выходит за правую границу */
    .how-hand-wrap {
      position: absolute;
      right: -280px;
      bottom: -360px;
      z-index: 5; /* выше inner и всего текста/иконок */
      pointer-events: none;
    }

    .how-hand {
      display: block;
      max-height: 780px;
      width: auto;
      height: auto;
    }

    @media (max-width: 1200px) {
      .how-inner {
        padding-inline: 20px;
      }
      .how-center {
        top: 225px;
        transform: translateX(-50%) scale(.92);
      }
      .how-hand-wrap {
        right: -220px;
        bottom: -342px;
        transform: scale(.95);
      }
    }

    @media (max-width: 992px) {
      .how-steps {
        gap: 30px;
      }
    }

    @media (max-width: 768px) {
      .how-page {
        padding-bottom: 320px; /* чуть больше запаса снизу */
      }

      .how-title-text {
        font-size: 30px;
      }

      .how-center {
        top: 230px;
        transform: translate(-50%, 0) scale(.75);
      }

      .how-steps {
        margin-top: 260px;
        flex-wrap: wrap;
      }

      .how-hand-wrap {
        position: absolute;
        left: 50%;
        right: auto;
        bottom: -420px;                 /* поднимаем руку выше */
        transform: translate(-35%, 0) scale(.78);
        z-index: 5;
        pointer-events: none;
      }

      /* ВАЖНО: двигаем ВЕСЬ шаг 5 вниз */
      .how-step--5 {
        margin-top: 240px; /* опустить блок ниже руки */
        text-align: center;
      }

      .how-step--5 .how-step-badge {
        display: block;
        margin: 0 auto 14px; /* центр плашки над текстом */
      }

      .how-step--5 .how-step-caption {
        margin: 0 auto;
        max-width: 280px; /* чтобы текст не расползался по всей ширине */
      }

      .how-bottom-text {
        margin-top: 50px;
      }

      /* Поднимаем туман выше — ближе к 1-й плашке только на мобилке */
      .how-fog-back {
        bottom: -180px;   /* было -60px, теперь туман сильно выше */
      }
      .how-fog-front {
        bottom: 2000px;   /* было -40px, чуть выше заднего слоя */
      }
    }

    /* совсем узкие экраны */
    @media (max-width: 480px) {
      .how-hand-wrap {
        bottom: -320px;                 /* поднимаем руку выше на узких экранах */
        transform: translate(-30%, 0) scale(.72);
      }

      .how-step--5 {
        margin-top: 220px; /* чуть меньше, чтобы не было огромной дыры */
      }
    }
  </style>

  <div class="how-page">
    {# туман — за всем #}
    <img class="how-fog-back"  src="{{ asset('images/туман.webp') }}" alt="туман">
    <img class="how-fog-front" src="{{ asset('images/туман.webp') }}" alt="туман">

    {# Tombstone - outside how-inner so it can be below fog #}
    <div class="how-center">
      <img class="how-tombstone" src="{{ asset('images/надгробие.webp') }}" alt="надгробие">
    </div>

    <div class="how-inner">
      <h2 class="how-title-text">
        <span>ПРОСТО СКАЧАТЬ</span>
        <span>И ПРОСТО ИСПОЛЬЗОВАТЬ</span>
      </h2>

      <div class="how-steps">
        <div class="how-step how-step--1">
          <img class="how-step-phone" src="{{ asset('images/1_section.webp') }}" alt="Шаг 1">
          <img class="how-step-badge" src="{{ asset('images/1 плашка.webp') }}" alt="1">
          <p class="how-step-caption">
            Генерируйте код на нашем сайте
          </p>
        </div>

        <div class="how-step how-step--2">
          <img class="how-step-flash" src="{{ asset('images/2 вспышки.png') }}" alt="">
          <img class="how-step-phone" src="{{ asset('images/2_section.webp') }}" alt="Шаг 2">
          <img class="how-step-badge" src="{{ asset('images/2 плашка.webp') }}" alt="2">
          <p class="how-step-caption">
            Скачивайте и гравируйте код на памятнике
          </p>
        </div>

        <div class="how-step how-step--3">
          <img class="how-step-phone" src="{{ asset('images/3_section.webp') }}" alt="Шаг 3">
          <img class="how-step-badge" src="{{ asset('images/3 плашка.webp') }}" alt="3">
          <p class="how-step-caption">
            Клиент сканирует QR-код
          </p>
        </div>

        <div class="how-step how-step--4">
          <img class="how-step-phone" src="{{ asset('images/4_section.webp') }}" alt="Шаг 4">
          <img class="how-step-badge" src="{{ asset('images/4 плашка.webp') }}" alt="4">
          <p class="how-step-caption">
            Клиент заполняет форму и создает страницу
          </p>
        </div>

        <div class="how-step how-step--5">
          <img class="how-step-badge" src="{{ asset('images/5 плашка.webp') }}" alt="5">
          <p class="how-step-caption">
            При наведении камеры на QR-код на памятнике
            клиент может открывать созданную им страницу
          </p>
        </div>
      </div>

      {# Hand positioned to extend beyond right border, aligned with step 5 #}
      <div class="how-hand-wrap">
        <img class="how-hand" src="{{ asset('images/5_section.webp') }}" alt="Телефон с QR-кодом">
      </div>

      
    </div>

    
  </div>
</section>


  {# ---------- THIRD SECTION: BENEFITS ---------- #}
  <section class="na-section-benefits">
    <div class="container">
      <div class="row align-items-center g-4">
        {# LEFT: ANGEL + CIRCLE #}
        <div class="col-lg-5">
          <div class="na-benefits-visual">
            <img
              src="{{ asset('images/circle-three.webp') }}"
              alt=""
              class="na-benefits-visual__circle"
              aria-hidden="true"
              loading="lazy"
              decoding="async"
            >
            {# FRONT FOG FROM RIGHT - for section 3 #}
            <img
              src="{{ asset('images/front-fog.webp') }}"
              alt=""
              class="na-benefits-visual__fog-front"
              aria-hidden="true"
              loading="lazy"
              decoding="async"
            >
            <img
              src="{{ asset('images/angel-three.webp') }}"
              alt="Ангел с телефоном"
              class="na-benefits-visual__angel"
              loading="lazy"
              decoding="async"
            >
          </div>
        </div>

        {# RIGHT: TEXT BENEFITS #}
        <div class="col-lg-7">
          <div class="na-benefits-copy">
            <h2 class="na-benefits-title">
              ИСПОЛЬЗУЯ<br/>
              QR КОД ВЫ<br/>
              ПОЛУЧИТЕ
            </h2>

            <div class="na-benefits-list">
              <div class="na-benefit">
                <h3 class="na-benefit__title">
                  КОНКУРЕНТНОЕ<br/>ПРЕИМУЩЕСТВО
                </h3>
                <p class="na-benefit__text">
                  Прогресс не стоит на месте, и QR-код всё чаще
                  входит в нашу жизнь. Теперь он с нами и после.
                  Данное предложение сделает вас уникальными в глазах
                  конкурентов — даже если ваши услуги выше рыночных.
                </p>
              </div>

              <div class="na-benefit">
                <h3 class="na-benefit__title">
                  УВЕЛИЧЕНИЕ<br/>СРЕДНЕГО ЧЕКА
                </h3>
                <p class="na-benefit__text">
                  Вы сможете продавать памятники дороже, затрачивая
                  на их изготовление столько же времени, сколько и раньше.
                </p>
              </div>

              <div class="na-benefit mb-0">
                <h3 class="na-benefit__title">
                  ВЫСОКУЮ<br/>КОНВЕРСИЮ В ПРОДАЖУ
                </h3>
                <p class="na-benefit__text mb-0">
                  Проект QR-кодов развивается, и в дальнейшем
                  фотографии будут оживать с помощью ИИ.
                  Такая услуга сделает ваши памятники дороже
                  на этапе изготовления.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  {# ---------- FOURTH SECTION: PHONE SLIDER ---------- #}
  <section class="na-section-design">
    <div class="container">

      <div class="na-design-heading">
        ВЫБОР<br/>
        ИНДИВИДУАЛЬНОГО<br/>
        ОФОРМЛЕНИЯ СТРАНИЦ
      </div>

      <div class="row align-items-center g-4">
        {# LEFT: PHONE SLIDER #}
        <div class="col-lg-5">
          <div class="na-phone-slider">
            <button
              type="button"
              class="na-phone-arrow na-phone-arrow--left"
              data-phone-prev
              aria-label="Предыдущий дизайн"
            >
              <img src="{{ asset('images/left-right-button.webp') }}" alt="" loading="lazy" decoding="async" />
            </button>

            <div class="na-phone-frame">
              <img
                src="{{ asset('images/phone.webp') }}"
                alt="Смартфон"
                class="na-phone-frame__img"
                loading="lazy"
                decoding="async"
              >
              <img
                src="{{ asset('images/1.webp') }}"
                alt="Превью страницы памяти"
                class="na-phone-preview"
                data-phone-preview
                loading="lazy"
                decoding="async"
              >
            </div>

            <button
              type="button"
              class="na-phone-arrow na-phone-arrow--right"
              data-phone-next
              aria-label="Следующий дизайн"
            >
              <img src="{{ asset('images/left-right-button.webp') }}" alt="" loading="lazy" decoding="async" />
            </button>
          </div>
        </div>

        {# RIGHT: TEXT CARD #}
        <div class="col-lg-7">
          <div class="na-design-card">
            <p class="na-design-card__text">
              Клиент при заполнении формы самостоятельно выбирает,
              как будет выглядеть страница в итоге. Для этого
              изготовлены разные стилистические формы с разными
              шрифтами и цветами исполнения.
            </p>

            <div class="na-design-pill">
              <span class="na-design-pill__number">5</span>
              <span class="na-design-pill__text">
                ПОПРОБУЙТЕ И ПОЛУЧИТЕ<br/>
                ПЯТЬ БЕСПЛАТНЫХ QR КОДОВ
              </span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  {# ---------- FOOTER STRIP ---------- #}
  <section class="na-footer-band">
    <div class="na-footer-fog"></div>

    <div class="na-footer-inner">
      <img
        src="{{ asset('images/contacts.webp') }}"
        alt="Контактные данные и публичная оферта"
        class="na-footer-card"
        loading="lazy"
        decoding="async"
      >
    </div>
  </section>

  {# ---------- MODALS ---------- #}
  {# Login Modal #}
  <div class="na-modal" id="na-modal-login" data-modal="login" aria-hidden="true">
    <div class="na-modal__overlay" data-modal-close></div>
    <div class="na-modal__content">
      <button class="na-modal__close" type="button" data-modal-close aria-label="Закрыть">&times;</button>
      <div class="na-modal__panel">
        <div class="na-auth-logo">
          <img src="{{ asset('images/logo.webp') }}" alt="Небесный Архив" class="na-auth-logo__img" loading="eager" fetchpriority="high" decoding="sync">
        </div>
        <div class="na-auth-heading">АВТОРИЗАЦИЯ</div>
        <form action="{{ path('security_login') }}" method="post" class="na-auth-form" id="na-login-form">
          <div id="na-login-error" class="na-auth-error" style="display:none;"></div>
          <div class="na-auth-field">
            <div class="na-auth-field-label">ЛОГИН</div>
            <input
              type="text"
              id="modal-username"
              name="_username"
              placeholder="Логин"
              autocomplete="username"
              required
            >
          </div>
          <div class="na-auth-field">
            <div class="na-auth-field-label">ПАРОЛЬ</div>
            <input
              type="password"
              id="modal-password"
              name="_password"
              placeholder="Пароль"
              autocomplete="current-password"
              required
            >
          </div>
          <input type="hidden" name="_target_path" value="{{ app.request.get('redirect_to') }}"/>
          <input type="hidden" name="_csrf_token" value="{{ csrf_token('authenticate') }}"/>
          <button type="submit" class="na-auth-submit">ВОЙТИ</button>
        </form>
      </div>
    </div>
  </div>

  {# Registration Modal #}
  <div class="na-modal" id="na-modal-register" data-modal="register" aria-hidden="true">
    <div class="na-modal__overlay" data-modal-close></div>
    <div class="na-modal__content na-modal__content--wide">
      <button class="na-modal__close" type="button" data-modal-close aria-label="Закрыть">&times;</button>
      <div class="na-modal__panel">
        <div class="na-cred-logo">
          <img src="{{ asset('images/logo.webp') }}" alt="Небесный Архив" class="na-cred-logo__img" loading="eager" fetchpriority="high" decoding="sync">
        </div>
        <div class="na-cred-heading">
          <span class="na-cred-heading__pill">РЕГИСТРАЦИЯ</span>
        </div>
        <div id="na-register-error" class="na-cred-alert" style="display:none;"></div>
        <form action="{{ path('company_register') }}" method="post" class="na-cred-form" id="na-register-form">
          <div class="na-cred-field">
            <div class="na-cred-field__label">ЛОГИН</div>
            <div class="na-cred-field__input">
              <input
                type="text"
                name="user_create[username]"
                class="na-cred-input"
                placeholder="Введите логин (будет использоваться для входа)"
                required
              >
            </div>
          </div>
          <div class="na-cred-field">
            <div class="na-cred-field__label">ПАРОЛЬ</div>
            <div class="na-cred-field__input">
              <input
                type="password"
                name="user_create[newPassword][first]"
                class="na-cred-input"
                placeholder="Придумайте пароль"
                required
              >
            </div>
          </div>
          <div class="na-cred-field">
            <div class="na-cred-field__label">НОМЕР ТЕЛЕФОНА</div>
            <div class="na-cred-field__input">
              <input
                type="tel"
                class="na-cred-input na-cred-phone-input"
                placeholder="Например, 89001234567"
                pattern="[0-9]*"
                autocomplete="tel"
                id="modal-phone-number-input"
              >
            </div>
          </div>
          {# Hidden fields #}
          <input type="hidden" name="user_create[email]" id="modal-hidden-email-field" value="user@company.local">
          <input type="hidden" name="user_create[firstName]" value="Company">
          <input type="hidden" name="user_create[lastName]" value="User">
          <input type="hidden" name="user_create[newPassword][second]" id="modal-password-confirm" value="">
          {{ form_widget(registerForm._token) }}
          <div class="na-cred-terms">
            <label>
              <input type="checkbox" required>
              <span>Я согласен с <a href="#" target="_blank">условиями использования</a></span>
            </label>
          </div>
          <button type="submit" class="na-cred-submit">ЗАВЕРШИТЬ РЕГИСТРАЦИЮ</button>
        </form>
        <div class="na-cred-login-link">
          Уже есть аккаунт? <button type="button" class="na-link-button" data-modal-open="login" data-modal-close="register">Войти</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  {# Mobile-optimized conditional preloading - only critical above-the-fold images #}
  <script>
    (function() {
      'use strict';
      
      // Detect mobile and data-saver mode
      const isMobile = window.innerWidth <= 768;
      const prefersDataSaver = navigator.connection && navigator.connection.saveData;
      const slowConnection = navigator.connection && (navigator.connection.effectiveType === 'slow-2g' || navigator.connection.effectiveType === '2g');
      
      // Skip aggressive preloading on slow connections or data-saver mode
      if (prefersDataSaver || slowConnection) {
        console.log('⚡ Data-saver mode or slow connection detected - minimal image loading');
        return;
      }
      
      // Only preload critical above-the-fold images based on device
      const criticalImages = isMobile ? [
      "{{ asset('images/logo.webp') }}"
      ] : [
      "{{ asset('images/logo.webp') }}",
      "{{ asset('images/angel.webp') }}",
      "{{ asset('images/circle.webp') }}"
      ];
      
      // Preload critical images
      criticalImages.forEach(src => {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.as = 'image';
        link.href = src;
        document.head.appendChild(link);
      });
    
      // Intersection Observer for smart lazy loading
      if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              
              // Load image if not already loaded
              if (img.dataset.src && !img.src) {
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
              }
              
              // Mark as observed to prevent reloading
              img.classList.add('na-img-loaded');
              observer.unobserve(img);
            }
          });
        }, {
          // Start loading 300px before image enters viewport
          rootMargin: '300px 0px',
          threshold: 0.01
        });
    
        // Observe all lazy-load images
        const lazyImages = document.querySelectorAll('img[loading="lazy"]');
        lazyImages.forEach(img => {
          // Add cache class to prevent reloading
          img.classList.add('na-img-cacheable');
          // Only observe if not in critical above-fold area
          const rect = img.getBoundingClientRect();
          if (rect.top > window.innerHeight) {
            imageObserver.observe(img);
          }
        });
      }
    })();
  </script>
  <style>
    /* Scoped to homepage only - prevents affecting dashboard and other pages */
    body#homepage{
      --na-blue-1:#314664;
      --na-blue-2:#111b27;
      --na-ink:#e4edf9;
      --na-ink-weak:#c1ccdd;
      --na-outline:rgba(255,255,255,.55);
      --na-chip:#3b4e6a;
      background-color:#040913;
      color:#fff;
      min-height:100vh;
    }
    body.na-nav-open{
      overflow:hidden;
    }

    /* ---------- HERO BACKGROUND ---------- */
    /* hero bottom color = #111214 */
    .na-hero{
      position:relative;
      min-height:100vh;
      min-height:100svh;
      background:
        radial-gradient(ellipse 700px 500px at 25% 20%, rgba(81,106,139,0.45) 0%, rgba(49,70,100,0.25) 40%, transparent 70%),
        radial-gradient(ellipse 600px 400px at 70% 30%, rgba(81,106,139,0.35) 0%, rgba(49,70,100,0.2) 40%, transparent 70%),
        linear-gradient(to bottom,
          #0f1419 0%,
          #0f1419 35%,
          #111214 65%,
          #111214 100%);
      color:#fff;
      overflow:hidden;
      padding-bottom:40px;
      isolation:isolate;
    }
    .na-hero::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(1100px 420px at 40% 100%, rgba(0,0,0,.4), transparent 60%),
        linear-gradient(to bottom, transparent 0%, rgba(0,0,0,.25) 100%);
      mix-blend-mode:multiply; opacity:.6;
    }
    .na-hero::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:
        repeating-linear-gradient(0deg, rgba(255,255,255,.012), rgba(255,255,255,.012) 2px, transparent 2px, transparent 4px),
        linear-gradient(to bottom, transparent 0%, transparent 85%, rgba(40,50,79,0.4) 95%, #28324f 100%);
      opacity:.22;
    }

    .na-hero__topbar{
      padding:18px 0 10px;
      position:relative;
      z-index:20;
    }
    .na-topline{
      width:100%;
      display:flex;
      align-items:center;
      gap:.75rem;
      flex-wrap:wrap;
    }
    .na-topline__panel{
      display:flex;
      align-items:center;
      gap:1rem;
      flex-wrap:wrap;
    }
    .na-top-links{
      display:flex;
      align-items:center;
      gap:.45rem;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .na-nav-toggle{
      display:none;
      width:42px;
      height:42px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,.55);
      background:transparent;
      padding:0;
      justify-content:center;
      align-items:center;
      flex-direction:column;
      gap:5px;
      transition:background .2s ease, border-color .2s ease;
    }
    .na-nav-toggle span{
      display:block;
      width:18px;
      height:2px;
      border-radius:999px;
      background:#fff;
    }
    .na-nav-toggle[aria-expanded="true"]{
      background:rgba(255,255,255,.15);
      border-color:#fff;
    }

    .na-logo{
      display:flex;
      align-items:center;
    }
    .na-logo__img{
      height:auto;
      max-height:80px;
      width:auto;
      max-width:200px;
      display:block;
      image-rendering:auto;
      content-visibility:auto;
    }
    /* Prevent image reloading and repainting during scroll */
    body#homepage img {
      /* Force GPU acceleration for smoother scrolling */
      transform: translateZ(0);
      backface-visibility: hidden;
      /* Prevent layout shifts */
      content-visibility: auto;
      /* Cache rendered image to prevent reloading */
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
    
    /* Mark loaded images to prevent re-fetching */
    body#homepage img.na-img-loaded,
    body#homepage img.na-img-cacheable {
      will-change: auto; /* Reset will-change after load */
    }
    
    /* Contain layout for large decorative images */
    body#homepage .na-angel,
    body#homepage .na-angel__circle,
    body#homepage .na-angel__fog,
    body#homepage .na-angel__fog-front,
    body#homepage .na-angel__img {
      contain: layout style paint;
      will-change: transform;
    }
    
    /* Optimize sections with images */
    body#homepage .na-section-option,
    body#homepage .na-section-benefits,
    body#homepage .na-section-design {
      contain: layout style;
    }
    
    /* kill any lazy-load placeholders around images */
    body#homepage img[loading="lazy"]{
      background: none;
      min-height: 0;
    }
    
    /* Mobile-specific optimizations */
    @media (max-width: 768px) {
      /* Further reduce repaints on mobile */
      body#homepage img {
        will-change: auto;
        transform: translateZ(0) scale(1);
      }
      
      /* Hide decorative images on slow connections */
      @media (prefers-reduced-data: reduce) {
        body#homepage .na-angel__fog,
        body#homepage .na-angel__fog-front,
        body#homepage .na-angel__circle {
          display: none;
        }
      }
    }

    .na-logo__mark{
      display:inline-block;
      font-weight:800;
      letter-spacing:.06em;
      border:1px solid var(--na-outline);
      padding:.2rem .45rem;
      border-radius:.25rem;
      margin-right:.55rem;
      background:rgba(0,0,0,.25);
    }
    .na-logo__text{opacity:.9;}

    .na-lang-switch{
      display:inline-flex;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.25);
      border-radius:.35rem;
      padding:.15rem;
      gap:.15rem;
    }
    .na-lang-switch__item{
      color:var(--na-ink);
      text-decoration:none;
      padding:.3rem .65rem;
      border-radius:.25rem;
      font-size:.75rem;
      font-weight:600;
      letter-spacing:.05em;
      transition:all .2s ease;
      background:transparent;
    }
    .na-lang-switch__item:hover{
      color:#fff;
    }
    .na-lang-switch__item.active{
      background:rgba(255,255,255,.15);
      color:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.3);
    }

    .na-chip{
      color:#fff; text-decoration:none;
      background:var(--na-chip);
      padding:.4rem .9rem;
      border-radius:.5rem;
      letter-spacing:.04em;
      font-size:.8rem;
      border:none;
      cursor:pointer;
      display:inline-block;
      transition:background .2s ease;
    }
    .na-chip:hover{
      background:#4a5f7a;
    }
    button.na-chip{
      font-family:inherit;
    }

    .na-hero__inner{
      position:relative;
      z-index:10;
      padding-top:80px;
      padding-bottom:80px;
    }

    /* ---------- LEFT SIDE LAYOUT ---------- */
    .na-left{
      max-width:540px;
      padding-right:40px;
      position:relative;
      z-index:5;
    }

    .na-left-main{
      margin-top:15px;
    }
    /* Большой заголовок "ПОВЫСЬТЕ ПРОДАЖИ" */
    .na-left-main__title{
      font-family:"Times New Roman", Georgia, serif;
      font-weight:800;
      font-size:clamp(40px, 4.6vw, 64px);
      line-height:1.02;
      letter-spacing:0.08em;
      text-transform:uppercase;
      margin-bottom:28px;
      text-shadow:0 2px 6px rgba(0,0,0,.35);
    }
    /* Подзаголовок справа от заголовка */
    .na-left-main__subtitle{
      font-family:"FranklinGothicCond", "Times New Roman", serif;
      font-size:18px;
      line-height:1.45;
      letter-spacing:0.03em;
      text-transform:uppercase;
      margin-bottom:30px;
      color:var(--na-ink-weak);
    }

    /* Плашка "5 бесплатных QR-кодов" */
    .na-left-pill{
      display:inline-flex;
      align-items:center;
      gap:14px;
      padding:10px 20px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.55);
      background:rgba(3,7,18,0.75);
      backdrop-filter:blur(6px);
      margin-bottom:40px;
      box-shadow:0 8px 22px rgba(0,0,0,.4);
    }
    .na-left-pill__number{
      display:flex;
      align-items:center;
      justify-content:center;
      width:32px;
      height:32px;
      border-radius:999px;
      background:#f5f5f5;
      color:#111214;
      font-family:"Times New Roman", Georgia, serif;
      font-weight:700;
      font-size:18px;
    }
    .na-left-pill__text{
      font-family:"FranklinGothicCond", "Times New Roman", serif;
      font-size:14px;
      letter-spacing:0.04em;
      text-transform:uppercase;
    }

    .na-copy{
      margin-top:32px;
      max-width:520px;
      padding:0;
      background:none;
      border-radius:0;
      border:none;
      box-shadow:none;
      backdrop-filter:none;
    }
    /* Блок "НЕБЕСНЫЙ АРХИВ" */
    .na-copy__title{
      font-family:"Times New Roman", Georgia, serif;
      font-weight:900; /* bold */
      font-size:40px;
      line-height:1.1;
      letter-spacing:0.08em;
      text-transform:uppercase;
      margin-bottom:18px;
    }
    .na-copy__text{
      font-size:16px;
      line-height:1.6;
      color:rgba(255,255,255,0.9);
      margin-bottom:.7rem;
      font-weight:700; /* bold */
    }

    /* Круглая "100% гарантия" */
    .na-quality{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      margin-top:24px;
      padding:12px 24px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.4);
      background:rgba(255,255,255,0.1);
      backdrop-filter:blur(4px);
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      opacity:0.9;
      color:rgba(255,255,255,.9);
      text-align:center;
      white-space:nowrap;
    }

    /* mobile: move guarantee badge slightly to the left */
    @media (max-width: 767.98px){
      .na-quality{
        margin-left:0;
        margin-right:auto;
        transform:translateX(-10px);
      }
    }

    /* ---------- RIGHT / ANGEL ---------- */
    .col-lg-6.position-relative{
      overflow: visible !important;
    }

    .na-angel{
      position: relative;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      min-height: 720px;           /* angel bigger */
      z-index: 3;
      overflow: visible;
      line-height: 0;
    }

    /* back fog under everything but the background */
    .na-angel__fog-back{
      position: absolute;
      left: 50%;
      bottom: -120px;
      transform: translateX(-50%);
      width: 140%;
      max-width: none;
      opacity: 0.9;
      z-index: 1;
      pointer-events: none;
      object-fit: cover;
      object-position: center bottom;
    }

    /* blue circle behind wings */
    .na-angel__circle{
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 420px;
      opacity: 0.9;
      z-index: 2;
      pointer-events: none;
    }

    /* main statue */
    .na-angel__img{
      position: relative;
      z-index: 3;
      max-height: 820px;           /* bigger statue */
      width: auto;
      display: block;
      filter: drop-shadow(0 40px 90px rgba(0,0,0,0.85));
      pointer-events: none;
    }

    /* front fog overlapping legs / base */
    .na-angel__fog-front{
      position: absolute;
      right: -160px;
      bottom: -80px;
      width: 90%;
      max-width: 820px;
      opacity: 0.95;
      z-index: 10; /* top layer - above everything */
      pointer-events: none;
      object-fit: cover;
      object-position: center bottom;
    }

    /* badge */
    .na-badge{
      position:absolute;
      bottom:20%;
      left:6%;
      width:130px;
      height:130px;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index:5;
    }
    .na-badge__ring{
      position:absolute;
      inset:0;
      border-radius:50%;
      border:9px solid rgba(255,255,255,.26);
      box-shadow:inset 0 0 0 2px rgba(255,255,255,.65), 0 10px 28px rgba(0,0,0,.6);
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(0,0,0,.25));
    }
    .na-badge__center{
      position:relative;
      z-index:2;
      font-weight:800;
      font-size:26px;
      color:#fff;
      text-shadow:0 2px 6px rgba(0,0,0,.35);
    }
    .na-badge__text{
      position:absolute;
      bottom:-20px;
      left:50%;
      transform:translateX(-50%);
      width:190px;
      text-align:center;
      font-size:11px;
      letter-spacing:.18em;
      color:var(--na-ink);
      opacity:.9;
      white-space:nowrap;
    }

    /* play button */
    /* Кнопка play над правым плечом */
    .na-play{
      position:absolute;
      top:150px;
      right:18%;
      z-index:5;
      border:none;
      background:transparent;
      padding:0;
      cursor:pointer;
    }
    .na-play__img{
      width:96px;
      height:auto;
      display:block;
    }

    /* ---------- NEW SECTION: OPTION TWO ---------- */
    .na-section-option{
      position:relative;
      padding:0;
      background:linear-gradient(to bottom, #0c111a 0%, #05070b 100%);
      overflow:hidden;
    }

    .na-option-visual{
      position:relative;
      display:flex;
      justify-content:center;
      align-items:center;
      width:100%;
    }
    .na-option-visual__img{
      width:100%;
      max-width:100%;
      height:auto;
      display:block;
    }

    /* ---------- RESPONSIVE ---------- */
    @media (max-width:1199.98px){
      .na-left{ padding-right:1.5rem; }
      .na-angel{ min-height:560px; }
      .na-angel__circle{ right:10%; width:min(380px,78%); }
    }
    @media (max-width:991.98px){
      .na-left{
        padding-right:0;
        text-align:center;
        margin-bottom:30px;
      }
      .na-left-main__title{
        font-size:34px;
      }
      .na-angel{
        margin-top:40px;
        min-height:520px;
        transform: scale(0.85);   /* smaller on mobile */
        transform-origin: center bottom;
      }
      .na-angel__img{
        max-height:620px;
      }
      .na-angel__fog{
        bottom:-80px;
        width:150%;
      }
      .na-angel__fog-front{
        right:-80px;
        bottom:-30px;
        width:90%;
      }
      .na-play{
        top:120px;
        right:50%;
        transform:translateX(50%);
      }
    }

    @media (max-width:767.98px){
      .na-left{
        padding:0 1rem;
        text-align:center;
      }
      .na-left-main__title br{
        display:none;
      }
      .na-left-pill{
        width:100%;
        justify-content:center;
      }
      .na-copy{
        margin-left:auto;
        margin-right:auto;
      }
      .na-nav-toggle{display:flex;}
      .na-topline__panel{
        width:100%;
        flex-direction:column;
        align-items:flex-start;
        display:none;
        gap:.7rem;
        padding-top:.35rem;
      }
      .na-topline__panel.is-open{
        display:flex;
      }
      .na-angel{
        min-height:420px;
        transform: scale(0.8);    /* even smaller on very small screens */
        transform-origin: center bottom;
      }
      .na-angel__circle{
        left:10%;
        right:auto;
      }
      .na-top-links{
        flex-direction:column;
        width:100%;
      }
      .na-chip{
        width:100%;
        text-align:center;
      }
      .na-lang-switch{
        width:100%;
        justify-content:space-between;
      }
    }

    /* --- FIX ANGEL BLOCK & FOG (BASE) --- */

    /* allow fog and circle to overflow */
    body#homepage .na-angel,
    body#homepage .na-angel__circle,
    body#homepage .na-angel__fog-back,
    body#homepage .na-angel__fog-front,
    body#homepage .na-angel__img {
      contain: layout style;   /* no paint containment */
      overflow: visible;
    }

    /* base (no transform here – only size) */
    .na-angel{
      position: relative;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      min-height: 820px;
      z-index: 3;
      line-height: 0;
    }

    .na-angel__img{
      display: block;
      max-height: 900px;
      width: auto;
      filter: drop-shadow(0 40px 90px rgba(0,0,0,0.85));
      pointer-events: none;
    }

    .na-angel__fog-back{
      position: absolute;
      left: 50%;
      bottom: -180px;
      transform: translateX(-50%);
      width: 155%;
      max-width: none;
      opacity: 0.9;
      pointer-events: none;
      object-fit: cover;
      object-position: center bottom;
    }

    .na-angel__fog-front{
      position: absolute;
      bottom: -110px;
      right: -210px;
      width: 105%;
      max-width: 820px;
      opacity: 0.95;
      pointer-events: none;
      object-fit: cover;
      object-position: center bottom;
      z-index: 4;
    }

    .na-angel__circle{
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 420px;
      opacity: 0.9;
      pointer-events: none;
    }


















    /* ---------- THIRD SECTION: BENEFITS ---------- */
    .na-section-benefits{
      position:relative;
      padding:90px 0 120px;
      background:#111214;
      color:#fff;
      overflow:hidden;
    }

    .na-section-benefits::before{
      content:"";
      position:absolute;
      left:0;
      right:0;
      bottom:-100px;
      height:650px;
      background:url('{{ asset('images/fog-three.webp') }}')
                 center bottom / cover no-repeat;
      opacity:1;
      pointer-events:none;
      z-index:0;

      /* более видимый туман - меньше обрезаем */
      mask-image:linear-gradient(
        to top,
        rgba(0,0,0,1)   0%,
        rgba(0,0,0,1)  50%,
        rgba(0,0,0,.8) 65%,
        rgba(0,0,0,.5) 80%,
        rgba(0,0,0,.2) 90%,
        rgba(0,0,0,0)  100%
      );
      -webkit-mask-image:linear-gradient(
        to top,
        rgba(0,0,0,1)   0%,
        rgba(0,0,0,1)  50%,
        rgba(0,0,0,.8) 65%,
        rgba(0,0,0,.5) 80%,
        rgba(0,0,0,.2) 90%,
        rgba(0,0,0,0)  100%
      );
    }
    .na-section-benefits .container{
      position:relative;
      z-index:2;  /* content above fog */
    }

    /* left visual */
    .na-benefits-visual{
      position:relative;
      display:flex;
      justify-content:flex-start;
      min-height:520px;
    }
    .na-benefits-visual__circle{
      position:absolute;
      top:0;
      left:0;
      width:min(380px, 80%);
      height:auto;
      opacity:.9;
      pointer-events:none;
      user-select:none;
      z-index:1;
    }
    .na-benefits-visual__fog-front{
      position:absolute;
      bottom:0;
      left:-500px;
      right:auto;
      width:200%;
      height:auto;
      max-height:60%;
      object-fit:cover;
      object-position:left bottom;
      opacity:1;
      pointer-events:none;
      user-select:none;
      z-index:10; /* on top of everything - section and angel */
      /* Fade from left (fully visible) to right (transparent), and from bottom to top */
      mask-image:
        linear-gradient(to right, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 25%, rgba(0,0,0,.7) 50%, rgba(0,0,0,.3) 75%, rgba(0,0,0,0) 100%),
        linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 20%, rgba(0,0,0,.8) 40%, rgba(0,0,0,.5) 60%, rgba(0,0,0,.2) 80%, rgba(0,0,0,0) 100%);
      -webkit-mask-image:
        linear-gradient(to right, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 25%, rgba(0,0,0,.7) 50%, rgba(0,0,0,.3) 75%, rgba(0,0,0,0) 100%),
        linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 20%, rgba(0,0,0,.8) 40%, rgba(0,0,0,.5) 60%, rgba(0,0,0,.2) 80%, rgba(0,0,0,0) 100%);
      mask-composite: intersect;
      -webkit-mask-composite: source-in;
    }
    .na-benefits-visual__angel{
      position:relative;
      z-index:2;
      width:min(420px, 92%);
      height:auto;
      filter:drop-shadow(0 30px 65px rgba(0,0,0,.9));
      user-select:none;
      pointer-events:none;
    }

    /* right text side */
    .na-benefits-copy{
      text-align:center;
      max-width:520px;
      margin:0 auto;
    }
    .na-benefits-title{
      font-family:"Times New Roman", Georgia, serif;
      font-weight:900; /* bold */
      font-size:clamp(32px,4vw,48px); /* bigger */
      line-height:1.1;
      letter-spacing:.06em;
      text-transform:uppercase;
      margin-bottom:2.4rem;
    }

    .na-benefits-list{
      display:flex;
      flex-direction:column;
      gap:2.3rem;
    }
    .na-benefit__title{
      font-family:"Times New Roman", Georgia, serif;
      font-weight:900; /* bold */
      font-size:clamp(20px,2vw,28px); /* bigger */
      line-height:1.3;
      letter-spacing:.08em;
      text-transform:uppercase;
      margin-bottom:.8rem;
    }
    .na-benefit__text{
      font-size:16px; /* bigger */
      line-height:1.6;
      color:var(--na-ink-weak);
      margin-bottom:0;
      font-weight:700; /* bold */
    }

    /* responsive tweaks */
    @media (max-width:1199.98px){
      .na-benefits-visual{
        justify-content:center;
        margin-bottom:30px;
      }
    }
    @media (max-width:991.98px){
      .na-section-benefits{
        padding-top:70px;
        padding-bottom:90px;
      }
      .na-benefits-copy{
        max-width:100%;
      }
    }

    /* ---------- FOURTH SECTION: PHONE SLIDER ---------- */
    .na-section-design{
      position:relative;
      padding:80px 0 110px;
      background:#111214;
      color:#fff;
      overflow:hidden;
    }

    .na-design-heading{
      font-family:"Times New Roman", Georgia, serif;
      font-weight:800;
      font-size:clamp(26px,3vw,34px);
      line-height:1.1;
      letter-spacing:.06em;
      text-transform:uppercase;
      text-align:right;
      margin-bottom:42px;
      text-shadow:0 2px 6px rgba(0,0,0,.6);
    }

    /* phone slider */
    .na-phone-slider{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:18px;
    }

    .na-phone-frame{
      position:relative;
      display:inline-block;
    }
    .na-phone-frame__img{
      display:block;
      width:260px;
      height:auto;
    }

    /* preview inside phone screen */
    .na-phone-preview{
      position:absolute;
      top:11%;
      left:13%;
      width:74%;
      height:78%;
      object-fit:cover;
      border-radius:16px;
    }

    .na-phone-arrow{
      border:none;
      padding:0;
      background:transparent;
      cursor:pointer;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:transform .15s ease, opacity .15s ease;
      opacity:.9;
    }
    .na-phone-arrow img{
      width:100%;
      height:100%;
      display:block;
    }
    .na-phone-arrow--right img{
      transform:scaleX(-1); /* mirror for right arrow */
    }
    .na-phone-arrow:hover{
      transform:translateY(-1px) scale(1.03);
      opacity:1;
    }

    /* right text card */
    .na-design-card{
      max-width:560px;
      margin-left:auto;
      padding:1.8rem 2rem 2rem;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.45);
      background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.3));
      box-shadow:0 18px 40px rgba(0,0,0,.7);
    }
    .na-design-card__text{
      font-size:14px;
      line-height:1.6;
      color:var(--na-ink-weak);
      margin:0 0 1.4rem;
    }

    .na-design-pill{
      display:inline-flex;
      align-items:stretch;
      gap:0;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 10px 26px rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.25);
    }
    .na-design-pill__number{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:70px;
      padding:1rem 1.2rem;
      font-weight:700;
      font-size:32px;
      background:#2d3f5f;
      border-right:1px solid rgba(255,255,255,.15);
    }
    .na-design-pill__text{
      display:flex;
      align-items:center;
      padding:1rem 1.5rem;
      font-size:11px;
      line-height:1.4;
      text-transform:uppercase;
      letter-spacing:.08em;
      background:#4a6391;
    }

    @media (max-width:991.98px){
      .na-design-heading{
        text-align:center;
      }
      .na-design-card{
        margin-right:auto;
        margin-top:26px;
      }
      .na-phone-slider{
        margin-bottom:12px;
      }
    }

    /* ---------- FOOTER STRIP ---------- */
    .na-footer-band{
      position:relative;
      padding:70px 0 60px;
      background:#111214;
      overflow:hidden;
    }

    /* fog behind everything */
    .na-footer-fog{
      position:absolute;
      left:50%;
      bottom:-120px;
      transform:translateX(-50%);
      width:140%;
      max-width:1700px;
      height:400px;
      background:url('{{ asset('images/footer-fog.webp') }}') center bottom / cover no-repeat;
      opacity:.9;
      pointer-events:none;
      z-index:1;

      mask-image:linear-gradient(
        to top,
        rgba(0,0,0,1) 0%,
        rgba(0,0,0,1) 30%,
        rgba(0,0,0,.65) 60%,
        rgba(0,0,0,.25) 80%,
        rgba(0,0,0,0) 100%
      );
      -webkit-mask-image:linear-gradient(
        to top,
        rgba(0,0,0,1) 0%,
        rgba(0,0,0,1) 30%,
        rgba(0,0,0,.65) 60%,
        rgba(0,0,0,.25) 80%,
        rgba(0,0,0,0) 100%
      );
    }

    .na-footer-inner{
      position:relative;
      z-index:2;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .na-footer-card{
      max-width:520px;
      width:100%;
      height:auto;
      display:block;
      filter:drop-shadow(0 12px 30px rgba(0,0,0,.8));
    }

    @media (max-width:767.98px){
      .na-footer-band{
        padding-top:50px;
        padding-bottom:50px;
      }
      .na-footer-card{
        max-width:90%;
      }
    }

    /* ---------- MODALS ---------- */
    .na-modal{
      position:fixed;
      inset:0;
      z-index:9999;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
    }
    .na-modal[aria-hidden="false"]{
      display:flex;
    }
    .na-modal__overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.85);
      backdrop-filter:blur(4px);
    }
    .na-modal__content{
      position:relative;
      z-index:1;
      width:100%;
      max-width:480px;
      max-height:90vh;
      overflow-y:auto;
      background:url('{{ asset('images/credential-bg.webp') }}') center center / cover no-repeat;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.2);
      box-shadow:0 24px 60px rgba(0,0,0,.9);
      position:relative;
    }
    .na-modal__content::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 80% 40%, rgba(255,255,255,.1), transparent 60%),
                 linear-gradient(to bottom right, rgba(0,0,0,.55), rgba(0,0,0,.3));
      mix-blend-mode:multiply;
      pointer-events:none;
      border-radius:20px;
    }
    .na-modal__content--wide{
      max-width:520px;
    }
    .na-modal__close{
      position:absolute;
      top:16px;
      right:16px;
      width:36px;
      height:36px;
      border:none;
      background:rgba(255,255,255,.15);
      border-radius:50%;
      color:#fff;
      font-size:24px;
      line-height:1;
      cursor:pointer;
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background .2s ease;
    }
    .na-modal__close:hover{
      background:rgba(255,255,255,.25);
    }
    .na-modal__panel{
      position:relative;
      z-index:2;
      padding:40px 32px 32px;
    }

    /* Auth form styles in modal */
    .na-modal__panel .na-auth-logo{
      display:inline-flex;
      align-items:center;
      margin-bottom:26px;
    }
    .na-modal__panel .na-auth-logo__img{
      height:auto;
      max-height:60px;
      width:auto;
      max-width:180px;
      display:block;
    }
    .na-modal__panel .na-auth-heading{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:.9rem 2.4rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.9);
      background:radial-gradient(circle at 50% 0, #4f7ff6, #1f3a87);
      box-shadow:0 0 24px rgba(63,119,255,.75);
      font-family:"Times New Roman", Georgia, serif;
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
      margin-bottom:40px;
      font-size:1.1rem;
    }
    .na-modal__panel .na-auth-form{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .na-modal__panel .na-auth-field{
      display:flex;
      align-items:center;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.75);
      background:rgba(0,0,0,.35);
      box-shadow:0 16px 32px rgba(0,0,0,.65);
      overflow:hidden;
      min-height:64px;
    }
    .na-modal__panel .na-auth-field-label{
      padding:0 24px;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      white-space:nowrap;
      border-right:1px solid rgba(255,255,255,.4);
      color:rgba(255,255,255,.85);
    }
    .na-modal__panel .na-auth-field input{
      flex:1;
      border:none;
      background:transparent;
      color:#fff;
      padding:14px 22px;
      font-size:.95rem;
      outline:none;
    }
    .na-modal__panel .na-auth-field input::placeholder{
      color:rgba(255,255,255,.55);
    }
    .na-modal__panel .na-auth-submit{
      margin-top:26px;
      align-self:flex-start;
      min-width:220px;
      padding:14px 36px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.9);
      background:radial-gradient(circle at 50% 0, #4f7ff6, #1f3a87);
      box-shadow:0 18px 40px rgba(0,0,0,.75), 0 0 32px rgba(63,119,255,.7);
      color:#fff;
      font-weight:600;
      letter-spacing:.1em;
      text-transform:uppercase;
      font-size:.9rem;
      cursor:pointer;
    }
    .na-modal__panel .na-auth-submit:hover{
      filter:brightness(1.05);
    }
    .na-modal__panel .na-auth-error{
      background:rgba(220,53,69,.95);
      border-radius:8px;
      padding:.6rem .9rem;
      font-size:.85rem;
      margin-bottom:4px;
    }

    /* Cred form styles in modal */
    .na-modal__panel .na-cred-logo{
      display:flex;
      align-items:center;
      margin-bottom:26px;
    }
    .na-modal__panel .na-cred-logo__img{
      height:auto;
      max-height:60px;
      width:auto;
      max-width:180px;
      display:block;
    }
    .na-modal__panel .na-cred-heading{
      margin-bottom:24px;
    }
    .na-modal__panel .na-cred-heading__pill{
      display:inline-block;
      padding:.75rem 2.6rem;
      border-radius:999px;
      font-size:1rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      background:radial-gradient(circle at 50% 0%, #5f8cff, #305399);
      box-shadow:0 0 24px rgba(90,135,255,.9), 0 14px 32px rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.7);
    }
    .na-modal__panel .na-cred-form{
      margin-top:10px;
    }
    .na-modal__panel .na-cred-alert{
      background:rgba(255,72,72,.16);
      border:1px solid rgba(255,120,120,.7);
      border-radius:10px;
      padding:.6rem .9rem;
      font-size:.85rem;
      margin-bottom:.75rem;
    }
    .na-modal__panel .na-cred-field{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.85);
      background:rgba(0,0,0,.35);
      box-shadow:0 8px 24px rgba(0,0,0,.7);
      padding:.55rem 1.4rem;
    }
    .na-modal__panel .na-cred-field__label{
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      white-space:nowrap;
      color:rgba(255,255,255,.85);
    }
    .na-modal__panel .na-cred-field__input{
      flex:1;
      margin-left:1.2rem;
    }
    .na-modal__panel .na-cred-input{
      width:100%;
      border:none;
      background:transparent;
      color:#fff;
      font-size:.95rem;
      padding:.2rem 0;
      outline:none;
    }
    .na-modal__panel .na-cred-input::placeholder{
      color:rgba(255,255,255,.55);
    }
    .na-modal__panel .na-cred-terms{
      font-size:.8rem;
      margin:8px 2px 18px;
      color:rgba(255,255,255,.85);
    }
    .na-modal__panel .na-cred-terms input{
      margin-right:.45rem;
    }
    .na-modal__panel .na-cred-terms a{
      color:#aac7ff;
      text-decoration:underline;
    }
    .na-modal__panel .na-cred-submit{
      width:260px;
      max-width:100%;
      border:none;
      border-radius:999px;
      padding:.9rem 1rem;
      margin-top:6px;
      margin-bottom:10px;
      font-size:.9rem;
      font-weight:600;
      letter-spacing:.12em;
      text-transform:uppercase;
      background:radial-gradient(circle at 50% 0%, #5f8cff, #305399);
      color:#fff;
      box-shadow:0 12px 28px rgba(0,0,0,.85), 0 0 22px rgba(90,135,255,.9);
      cursor:pointer;
    }
    .na-modal__panel .na-cred-submit:hover{
      transform:translateY(-1px);
    }
    .na-modal__panel .na-cred-login-link{
      margin-top:8px;
      font-size:.8rem;
      color:rgba(255,255,255,.85);
    }
    .na-link-button{
      background:none;
      border:none;
      color:#fff;
      text-decoration:underline;
      cursor:pointer;
      padding:0;
      font-size:inherit;
    }
    .na-link-button:hover{
      color:#aac7ff;
    }

    @media (max-width:575.98px){
      .na-modal__content{
        max-width:100%;
        border-radius:16px;
        max-height:95vh;
      }
      .na-modal__panel{
        padding:32px 24px 24px;
      }
    }

    /* ---------- DESKTOP ≥ 1200px ---------- */
    @media (min-width: 1200px) {
      /* Left column typography / spacing */
      .na-left {
        max-width: 520px;
        padding-right: 60px;
        padding-top: 70px;
      }

      .na-left-main {
        margin-top: 0;
      }

      .na-left-main__title {
        font-size: 64px;
        line-height: 1.05;
        letter-spacing: 0.09em;
        text-transform: uppercase;
        margin-bottom: 32px;
      }

      .na-left-main__subtitle {
        font-family: "FranklinGothicCond", "Times New Roman", serif;
        font-size: 17px;
        line-height: 1.35;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        max-width: 360px;
        margin-bottom: 32px;
      }

      .na-left-pill {
        margin-top: 6px;
        margin-bottom: 52px;
      }

      .na-copy {
        margin-top: 40px;
        max-width: 520px;
      }

      .na-copy__title {
        font-size: 34px;
        letter-spacing: 0.09em;
        line-height: 1.08;
      }

      /* Angel – bigger + shifted to the RIGHT */
      .na-angel {
        transform: translateX(70px) scale(1.1);
        transform-origin: center bottom;
      }

      .na-angel__img {
        height: 880px;
        max-height: none;
      }

      /* circle a little more to the LEFT and UP behind angel */
      .na-angel__circle {
        top: 30px;              /* moved up more */
        left: 45%;              /* moved left more */
        transform: translateX(-50%);
        max-width: 460px;
      }

      /* back fog a bit deeper */
      .na-angel__fog-back {
        bottom: -210px;
        width: 160%;
      }

      /* front fog a bit more to the RIGHT */
      .na-angel__fog-front {
        bottom: -140px;
        right: -180px;
        width: 110%;
      }

      /* play button on wing */
      .na-play {
        top: 215px;
        right: 22%;
      }

      /* give statue a bit more column width */
      .na-hero__inner .row > .col-lg-6:first-child {
        flex: 0 0 46%;
        max-width: 46%;
      }
      .na-hero__inner .row > .col-lg-6.position-relative {
        flex: 0 0 54%;
        max-width: 54%;
      }
    }

    /* ---------- LARGE TABLETS / SMALL DESKTOPS ---------- */
    @media (min-width: 992px) and (max-width: 1199.98px) {
      .na-angel {
        transform: translateX(30px) scale(1.02);
        transform-origin: center bottom;
      }
    }

    /* ---------- TABLETS < 992px ---------- */
    @media (max-width: 991.98px) {
      .na-angel {
        margin-top: 40px;
        min-height: 520px;
        transform: translateX(10px) scale(0.95);   /* bigger on tablet */
        transform-origin: center bottom;
      }

      .na-angel__img {
        max-height: 620px;
      }

      .na-angel__fog-front{
        right: -80px;
        bottom: -40px;
        width: 100%;
      }
    }

    /* ---------- MOBILE < 768px ---------- */
    @media (max-width: 767.98px){
      .na-angel{
        min-height: 420px;
        transform: translateX(0) scale(0.95);      /* bigger on mobile */
        transform-origin: center bottom;
      }

      .na-angel__circle{
        left: 50%;
        transform: translateX(-50%);
      }
    }
  </style>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script>
    (function () {
      // Phone slider functionality with preloaded images for instant switching
      const slides = [
        "{{ asset('images/1.webp') }}",
        "{{ asset('images/2.webp') }}",
        "{{ asset('images/3.webp') }}",
        "{{ asset('images/4.webp') }}",
        "{{ asset('images/5.webp') }}",
      ];

      // Preload all slider images for instant switching (mobile-optimized)
      const isMobile = window.innerWidth <= 768;
      const prefersDataSaver = navigator.connection && navigator.connection.saveData;
      
      if (!prefersDataSaver) {
        slides.forEach((src, index) => {
          // Preload first image immediately, others after a short delay
          if (index === 0 || !isMobile) {
            const img = new Image();
            img.src = src;
          } else if (index < 3) {
            // Preload next 2 images after 500ms on mobile
            setTimeout(() => {
              const img = new Image();
              img.src = src;
            }, 500);
          }
        });
      }

      let current = 0;
      const preview = document.querySelector('[data-phone-preview]');
      const prevBtn = document.querySelector('[data-phone-prev]');
      const nextBtn = document.querySelector('[data-phone-next]');

      if (!preview || !prevBtn || !nextBtn) return;

      function updateSlide() {
        // Use cached image if available, otherwise load
        const img = new Image();
        img.onload = function() {
          preview.src = slides[current];
          preview.classList.add('na-slide-loaded');
        };
        img.src = slides[current];
      }

      prevBtn.addEventListener('click', function () {
        current = (current - 1 + slides.length) % slides.length;
        updateSlide();
      });

      nextBtn.addEventListener('click', function () {
        current = (current + 1) % slides.length;
        updateSlide();
      });
      
      // Initial load
      updateSlide();
    })();

    // Language switcher
    (function () {
      const langItems = document.querySelectorAll('.na-lang-switch__item');
      
      langItems.forEach(item => {
        item.addEventListener('click', function (e) {
          e.preventDefault();
          
          // Remove active from all
          langItems.forEach(lang => lang.classList.remove('active'));
          
          // Add active to clicked
          this.classList.add('active');
          
          // Here you can add actual language switching logic
          const selectedLang = this.getAttribute('data-lang');
          console.log('Language switched to:', selectedLang);
          
          // Optional: reload page with locale parameter or make AJAX call
          // window.location.href = '?locale=' + selectedLang;
        });
      });
    })();

    // Mobile navigation toggle
    (function () {
      const toggle = document.querySelector('[data-nav-toggle]');
      const panel = document.querySelector('[data-nav-panel]');
      if (!toggle || !panel || !window.matchMedia) {
        return;
      }

      const body = document.body;
      const mobileQuery = window.matchMedia('(max-width: 767.98px)');
      let isMobile = false;

      const closePanel = () => {
        if (!isMobile) {
          return;
        }
        toggle.setAttribute('aria-expanded', 'false');
        panel.classList.remove('is-open');
        panel.setAttribute('aria-hidden', 'true');
        body.classList.remove('na-nav-open');
      };

      const openPanel = () => {
        if (!isMobile) {
          return;
        }
        toggle.setAttribute('aria-expanded', 'true');
        panel.classList.add('is-open');
        panel.setAttribute('aria-hidden', 'false');
        body.classList.add('na-nav-open');
      };

      const syncState = () => {
        isMobile = mobileQuery.matches;
        if (isMobile) {
          closePanel();
        } else {
          panel.classList.remove('is-open');
          panel.setAttribute('aria-hidden', 'false');
          toggle.setAttribute('aria-expanded', 'false');
          body.classList.remove('na-nav-open');
        }
      };

      syncState();
      if (mobileQuery.addEventListener) {
        mobileQuery.addEventListener('change', syncState);
      } else if (mobileQuery.addListener) {
        mobileQuery.addListener(syncState);
      }

      toggle.addEventListener('click', () => {
        if (!isMobile) {
          return;
        }
        const expanded = toggle.getAttribute('aria-expanded') === 'true';
        if (expanded) {
          closePanel();
        } else {
          openPanel();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closePanel();
        }
      });
    })();

    // Modal functionality
    (function() {
      const openButtons = document.querySelectorAll('[data-modal-open]');
      const closeButtons = document.querySelectorAll('[data-modal-close]');
      const modals = document.querySelectorAll('.na-modal');
      const body = document.body;

      function openModal(modalId) {
        const modal = document.getElementById('na-modal-' + modalId);
        if (modal) {
          // Remove focus from any element before showing modal
          if (document.activeElement && document.activeElement.blur) {
            document.activeElement.blur();
          }
          modal.setAttribute('aria-hidden', 'false');
          body.style.overflow = 'hidden';
          
          // Refresh CSRF token for login form if it's the login modal
          if (modalId === 'login') {
            const csrfInput = modal.querySelector('input[name="_csrf_token"]');
            if (csrfInput) {
              // Fetch fresh CSRF token
              fetch('{{ path('security_login') }}', {
                method: 'GET',
                credentials: 'same-origin'
              })
              .then(response => response.text())
              .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTokenInput = doc.querySelector('input[name="_csrf_token"]');
                if (newTokenInput && csrfInput) {
                  csrfInput.value = newTokenInput.value;
                  console.log('CSRF token refreshed');
                }
              })
              .catch(err => console.error('Failed to refresh CSRF token:', err));
            }
          }
          
          // Focus first input after a short delay
          setTimeout(() => {
            const firstInput = modal.querySelector('input[type="text"], input[type="password"], input[type="tel"]');
            if (firstInput) {
              firstInput.focus();
            }
          }, 100);
        }
      }

      function closeModal(modalId) {
        const modal = modalId ? document.getElement('na-modal-' + modalId) : document.querySelector('.na-modal[aria-hidden="false"]');
        if (modal) {
          // Remove focus from any element in modal before hiding
          const focusedElement = modal.querySelector(':focus');
          if (focusedElement && focusedElement.blur) {
            focusedElement.blur();
          }
          // Small delay to ensure focus is removed before setting aria-hidden
          setTimeout(() => {
            modal.setAttribute('aria-hidden', 'true');
            body.style.overflow = '';
            // Clear form errors
            const errorDiv = modal.querySelector('[id$="-error"]');
            if (errorDiv) {
              errorDiv.style.display = 'none';
              errorDiv.textContent = '';
            }
            // Reset forms
            const forms = modal.querySelectorAll('form');
            forms.forEach(form => form.reset());
          }, 50);
        }
      }

      openButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const modalId = this.getAttribute('data-modal-open');
          const closeId = this.getAttribute('data-modal-close');
          if (closeId) {
            closeModal(closeId);
          }
          openModal(modalId);
        });
      });

      closeButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const modalId = this.getAttribute('data-modal-close');
          closeModal(modalId);
        });
      });

      // Close on overlay click
      modals.forEach(modal => {
        const overlay = modal.querySelector('.na-modal__overlay');
        if (overlay) {
          overlay.addEventListener('click', () => {
            closeModal();
          });
        }
      });

      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      });

      // Registration form phone number handling
      const phoneInput = document.getElementById('modal-phone-number-input');
      const hiddenEmailField = document.getElementById('modal-hidden-email-field');
      const passwordFirst = document.querySelector('input[name="user_create[newPassword][first]"]');
      const passwordConfirm = document.getElementById('modal-password-confirm');

      if (phoneInput && hiddenEmailField) {
        function updateEmailFromPhone() {
          const phoneValue = phoneInput.value.replace(/\D/g, '');
          if (phoneValue) {
            hiddenEmailField.value = phoneValue + '@company.local';
          } else {
            const usernameField = document.querySelector('input[name="user_create[username]"]');
            if (usernameField && usernameField.value) {
              hiddenEmailField.value = usernameField.value + '@company.local';
            } else {
              hiddenEmailField.value = 'user@company.local';
            }
          }
        }
        phoneInput.addEventListener('input', updateEmailFromPhone);
        phoneInput.addEventListener('blur', updateEmailFromPhone);
      }

      // Sync password confirmation
      if (passwordFirst && passwordConfirm) {
        passwordFirst.addEventListener('input', function() {
          passwordConfirm.value = this.value;
        });
      }

      // Handle form submissions with AJAX
      const loginForm = document.getElementById('na-login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          const errorDiv = document.getElementById('na-login-error');
          errorDiv.style.display = 'none';
          errorDiv.textContent = '';
          
          // Debug: log form data
          console.log('Submitting login form:');
          for (let [key, value] of formData.entries()) {
            if (key === '_password') {
              console.log(key + ':', '***');
            } else {
              console.log(key + ':', value);
            }
          }
          
          // Use XMLHttpRequest instead of fetch for better compatibility
          const xhr = new XMLHttpRequest();
          xhr.open('POST', this.action, true);
          xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
          xhr.withCredentials = true;
          
          xhr.onload = function() {
            console.log('XHR status:', xhr.status);
            console.log('XHR response length:', xhr.responseText.length);
            console.log('XHR response preview:', xhr.responseText.substring(0, 200));
            
            // Check for redirect (302, 301, etc.) - this means success
            if (xhr.status >= 300 && xhr.status < 400) {
              const location = xhr.getResponseHeader('Location');
              console.log('XHR redirect to:', location);
              if (location) {
                if (location.includes('/login')) {
                  // Redirected back to login = failure
                  errorDiv.textContent = 'Неверный логин или пароль';
                  errorDiv.style.display = 'block';
                  return;
                } else {
                  // Redirect to dashboard = success
                  window.location.href = location;
                  return;
                }
              }
            }
            
            // Try to parse as JSON first
            let data;
            const contentType = xhr.getResponseHeader('Content-Type') || '';
            if (contentType.includes('application/json')) {
              try {
                data = JSON.parse(xhr.responseText);
                console.log('XHR JSON response:', data);
              } catch (e) {
                console.error('Failed to parse JSON:', e);
                data = { success: false, error: 'Ошибка обработки ответа' };
              }
            } else {
              // Not JSON - check if it's HTML with error or success
              if (xhr.status >= 200 && xhr.status < 300) {
                // Check if response contains login form (failure) or dashboard (success)
                if (xhr.responseText.includes('dashboard') || xhr.responseText.includes('admin')) {
                  // Success - redirect to dashboard
                  window.location.href = '{{ path('admin_dashboard') }}';
                  return;
                } else if (xhr.responseText.includes('АВТОРИЗАЦИЯ') || xhr.responseText.includes('login')) {
                  // Still on login page - parse for errors
                  const parser = new DOMParser();
                  const doc = parser.parseFromString(xhr.responseText, 'text/html');
                  const errorMsg = doc.querySelector('.na-auth-error');
                  if (errorMsg) {
                    data = { success: false, error: errorMsg.textContent };
                  } else {
                    data = { success: false, error: 'Неверный логин или пароль' };
                  }
                } else {
                  // Unknown response - assume success and redirect
                  window.location.href = '{{ path('admin_dashboard') }}';
                  return;
                }
              } else {
                // Error status
                const parser = new DOMParser();
                const doc = parser.parseFromString(xhr.responseText, 'text/html');
                const errorMsg = doc.querySelector('.na-auth-error');
                data = { 
                  success: false, 
                  error: errorMsg ? errorMsg.textContent : 'Ошибка входа' 
                };
              }
            }
            
            // Handle the response data
            if (data && !data.success) {
              errorDiv.textContent = data.error || 'Ошибка входа';
              errorDiv.style.display = 'block';
              if (data.debug) {
                console.error('Login error details:', data.debug);
              }
              const passwordField = document.getElementById('modal-password');
              if (passwordField) {
                passwordField.value = '';
                passwordField.focus();
              }
            } else if (data && data.success) {
              // Success - redirect
              if (data.redirect) {
                window.location.href = data.redirect;
              } else {
                window.location.href = '{{ path('admin_dashboard') }}';
              }
            }
          };
          
          xhr.onerror = function() {
            console.error('XHR error');
            errorDiv.textContent = 'Ошибка соединения. Попробуйте еще раз.';
            errorDiv.style.display = 'block';
          };
          
          xhr.send(formData);
        });
      }

      const registerForm = document.getElementById('na-register-form');
      if (registerForm) {
        registerForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          const errorDiv = document.getElementById('na-register-error');
          errorDiv.style.display = 'none';
          errorDiv.textContent = '';
          
          // Update email from phone before submission
          if (phoneInput && hiddenEmailField) {
            const phoneValue = phoneInput.value.replace(/\D/g, '');
            if (phoneValue) {
              hiddenEmailField.value = phoneValue + '@company.local';
            }
          }
          
          // Sync password confirmation
          if (passwordFirst && passwordConfirm) {
            passwordConfirm.value = passwordFirst.value;
          }

          fetch(this.action, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            },
            redirect: 'manual'
          })
          .then(response => {
            // Check if response is a redirect (302, 301, etc.)
            if (response.status >= 300 && response.status < 400) {
              const location = response.headers.get('Location');
              if (location) {
                window.location.href = location;
                return;
              }
            }
            
            // Check for JSON response
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
              return response.json();
            }
            
            // If status is 200, try to parse as JSON first, then HTML
            if (response.ok) {
              return response.text().then(text => {
                try {
                  return JSON.parse(text);
                } catch (e) {
                  const parser = new DOMParser();
                  const doc = parser.parseFromString(text, 'text/html');
                  const errorMsg = doc.querySelector('.na-cred-alert, .form-error');
                  if (errorMsg) {
                    return { success: false, errors: [errorMsg.textContent] };
                  }
                  return { success: true };
                }
              });
            }
            
            // For error status codes, try to get JSON error
            return response.json().catch(() => {
              return { success: false, errors: ['Ошибка регистрации'] };
            });
          })
          .then(data => {
            if (data && !data.success) {
              const errorText = Array.isArray(data.errors) ? data.errors.join(', ') : (data.error || 'Ошибка регистрации');
              errorDiv.textContent = errorText;
              errorDiv.style.display = 'block';
            } else if (data && data.success) {
              // Success - show message and open login modal
              alert(data.message || 'Регистрация успешна! Теперь вы можете войти в систему.');
              closeModal('register');
              // Clear registration form
              this.reset();
              // Open login modal
              setTimeout(() => {
                openModal('login');
              }, 300);
            }
          })
          .catch((error) => {
            console.error('Registration error:', error);
            errorDiv.textContent = 'Ошибка соединения. Попробуйте еще раз.';
            errorDiv.style.display = 'block';
          });
        });
      }
    })();
  </script>
{% endblock %}
